---
phase: 05-demo-submit
plan: 04
type: execute
wave: 3
depends_on: ["05-01", "05-02", "05-03"]
files_modified:
  - demo/stage_anomaly.sh
  - demo/cleanup_demo.sh
  - docs/render_architecture.sh
  - README.md
  - demo/scenario.md
  - demo/script.md
  - demo/recording_checklist.md
  - .planning/phases/04-human-loop/04-human-loop-VERIFICATION.md
  - .planning/config.json
  - .planning/STATE.md
  - .planning/phases/05-demo-submit/05-01-SUMMARY.md
  - .planning/phases/05-demo-submit/05-demo-submit-VERIFICATION.md
autonomous: true

must_haves:
  truths:
    - "Demo scripts correctly detect VM power state using 'az vm show -d' and remain safe to rerun"
    - "Diagram render script uses Docker fallback when npx/puppeteer fails"
    - "Demo docs do not contain personal identifiers (emails/subscription IDs) or secrets"
    - "Planning state and verification docs accurately reflect what was validated"
  artifacts:
    - path: ".planning/phases/05-demo-submit/05-04-SUMMARY.md"
      provides: "Hardening plan execution summary"
    - path: ".planning/phases/05-demo-submit/05-demo-submit-VERIFICATION.md"
      provides: "Phase 5 verification updated with hardening plan"
---

<objective>
Hardening pass after Phase 5 completion:
- Make the demo scripts robust (correct Azure CLI powerState retrieval, strict bash mode, readable output)
- Make architecture diagram rendering resilient (Docker fallback if npx fails)
- Scrub demo docs of personal identifiers
- Reconcile planning config drift and verification/state truthfulness
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/04-human-loop/04-human-loop-VERIFICATION.md
@.planning/phases/05-demo-submit/05-demo-submit-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden demo stage/cleanup scripts</name>
  <files>demo/stage_anomaly.sh, demo/cleanup_demo.sh</files>
  <action>
Ensure demo scripts are safe and correct:
- Require args (`--vm-name`, `--resource-group`) and support `--help`
- Use strict bash (`set -euo pipefail`)
- Validate `az` exists and Azure CLI is authenticated
- Read VM power state using `az vm show -d --query powerState`
- Print commands before running them
- Keep tags consistent between stage and cleanup
  </action>
  <verify>bash -n demo/stage_anomaly.sh && bash -n demo/cleanup_demo.sh</verify>
  <done>Scripts are syntax-valid, safe to rerun, and use `-d` for powerState.</done>
</task>

<task type="auto">
  <name>Task 2: Improve Mermaid render resilience</name>
  <files>docs/render_architecture.sh, docs/architecture.png</files>
  <action>
Make `docs/render_architecture.sh` robust:
- Prefer npx mermaid-cli
- If npx fails (common in headless CI), fallback to Docker minlag/mermaid-cli
- Fail clearly if neither is available
- Ensure output file exists and is non-empty
  </action>
  <verify>bash -n docs/render_architecture.sh && bash docs/render_architecture.sh && test -s docs/architecture.png</verify>
  <done>Render script consistently produces a non-empty PNG in this environment.</done>
</task>

<task type="auto">
  <name>Task 3: Scrub demo docs of personal identifiers</name>
  <files>demo/scenario.md, demo/script.md, demo/recording_checklist.md, README.md</files>
  <action>
Remove hardcoded personal identifiers from demo docs:
- Replace subscription IDs with `<your-subscription-id>` placeholders
- Remove personal emails/usernames from checklists
- Keep examples runnable and clear
  </action>
  <verify>rg -n "marcos\.jaen\.lego@gmail\.com|495eb1d8-99ac-40d1-9eaf-082d28b8ac56" -S . || true</verify>
  <done>No personal email or subscription ID remains in the repo.</done>
</task>

<task type="auto">
  <name>Task 4: Revert accidental planning config drift</name>
  <files>.planning/config.json</files>
  <action>
Restore `.planning/config.json` model lists to the repo baseline unless deliberately changed.
This avoids incidental changes to the GSD toolchain.
  </action>
  <verify>git diff --exit-code -- .planning/config.json</verify>
  <done>Planning config matches the committed baseline.</done>
</task>

<task type="auto">
  <name>Task 5: Reconcile state and verification docs</name>
  <files>.planning/STATE.md, .planning/phases/04-human-loop/04-human-loop-VERIFICATION.md, .planning/phases/05-demo-submit/05-01-SUMMARY.md, .planning/phases/05-demo-submit/05-demo-submit-VERIFICATION.md, .planning/phases/05-demo-submit/05-04-SUMMARY.md</files>
  <action>
Update planning docs to reflect reality:
- Phase 4 verification should distinguish what was validated locally vs what requires a public Slack callback / real Azure side effects
- Phase 5 docs should reflect the hardening pass (05-04)
- Update STATE plan counts/progress
- Create 05-04 summary
  </action>
  <verify>python3 -c "import pathlib; p=pathlib.Path('.planning/phases/05-demo-submit/05-04-SUMMARY.md'); assert p.exists() and p.stat().st_size>200"</verify>
  <done>Docs are consistent with the repo state and hardening changes.</done>
</task>

</tasks>

<output>
After completion, create `.planning/phases/05-demo-submit/05-04-SUMMARY.md`.
</output>
