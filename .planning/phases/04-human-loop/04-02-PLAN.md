---
phase: 04-human-loop
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/integrations/slack.py
  - src/integrations/message_format.py
  - src/web/app.py
  - src/models/approval.py
  - tests/test_slack_signature.py
autonomous: true
user_setup:
  - service: slack
    why: "Interactive approval buttons"
    env_vars:
      - name: SLACK_SIGNING_SECRET
        source: "Slack App -> Basic Information -> App Credentials"
      - name: SLACK_BOT_TOKEN
        source: "Slack App -> OAuth & Permissions"
    dashboard_config:
      - task: "Create a Slack app, enable Interactivity & Shortcuts, set request URL to /webhooks/slack/actions"
        location: "api.slack.com/apps"

must_haves:
  truths:
    - "Slack message includes Approve/Reject/Investigate buttons"
    - "Server verifies Slack signatures and records approval decision"
  artifacts:
    - path: "src/web/app.py"
      provides: "Slack actions endpoint"
    - path: "src/models/approval.py"
      provides: "Approval decision model"
  key_links:
    - from: "src/web/app.py"
      to: "src/integrations/slack.py"
      via: "signature verification"
      pattern: "verify_signature"
---

<objective>
Implement Slack interactive approvals (buttons) with signature verification and decision persistence in memory.

Purpose: Enable human-in-the-loop remediation approval.
Output: Slack actions endpoint + approval models + message buttons + tests for signature verification.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-human-loop/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add approval decision model + minimal in-memory store</name>
  <files>src/models/approval.py</files>
  <action>
Create `src/models/approval.py`:
- `ApprovalDecision` enum: `approve`, `reject`, `investigate`
- `ApprovalRecord`: `investigation_id`, `decision`, `decided_by`, `decided_at`, `reason` (optional)

Keep persistence in-memory for now (dict in coordinator/web module); Phase 5 can make it durable if needed.
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src python3 -c "from models.approval import ApprovalDecision; print('ok')"</verify>
  <done>Approval models exist and can represent decisions from Slack interactions.</done>
</task>

<task type="auto">
  <name>Task 2: Add Slack signature verification helper</name>
  <files>src/integrations/slack.py, tests/test_slack_signature.py</files>
  <action>
Update `src/integrations/slack.py`:
- Add `verify_signature(raw_body, headers) -> bool` implementing Slack signing secret verification:
  - use `X-Slack-Request-Timestamp` and `X-Slack-Signature`
  - compute HMAC SHA256 of `v0:{timestamp}:{raw_body}` and compare with signature
- Reject stale timestamps (e.g., older than 5 minutes).

Add `tests/test_slack_signature.py` to cover:
- valid signature accepted
- invalid signature rejected
- stale timestamp rejected
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src pytest -q</verify>
  <done>Signature verification exists and is covered by unit tests without needing Slack API access.</done>
</task>

<task type="auto">
  <name>Task 3: Add Slack interactive actions endpoint and wire buttons</name>
  <files>src/web/app.py, src/integrations/message_format.py</files>
  <action>
Update message formatting to include buttons (Block Kit actions) with action_ids:
- `approve_remediation`, `reject_remediation`, `investigate_more`
- Include an `investigation_id` in `value`.

Update `src/web/app.py`:
- Add `POST /webhooks/slack/actions` that:
  - reads raw body (Slack sends form-encoded `payload=`)
  - verifies signature
  - parses the payload JSON
  - records an ApprovalRecord in memory
  - responds with 200 and an acknowledgement message
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src pytest -q</verify>
  <done>Slack action endpoint exists and handles approve/reject/investigate decisions securely.</done>
</task>

</tasks>

<verification>
- `pytest` passes
- (If Slack app configured) clicking a button hits `/webhooks/slack/actions` and the server logs show the recorded decision
</verification>

<success_criteria>
- HUMAN-03 satisfied in dev: interactive buttons and signature verification implemented
</success_criteria>

<output>
After completion, create `.planning/phases/04-human-loop/04-02-SUMMARY.md`
</output>
