---
phase: 01-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - scripts/dev.sh
  - pytest.ini
  - tests/test_smoke.py
  - requirements.txt
  - .env.example
  - infra/foundry_config.yaml
  - src/azure/foundry.py
  - scripts/foundry_smoke.py
autonomous: true

user_setup:
  - service: azure_ai_foundry
    why: "Validate Foundry (Agent Framework SDK) project access"
    env_vars:
      - name: AZURE_AI_PROJECT_ENDPOINT
        source: "Azure AI Foundry project endpoint (format: https://{ai-services-account}.services.ai.azure.com/api/projects/{project-name} or /api/projects/_project)"
    dashboard_config:
      - task: "Create/identify the Foundry Project and copy its endpoint"
        location: "Azure AI Foundry / AI Studio"

must_haves:
  truths:
    - "Repo has a one-command dev server script"
    - "Unit tests run successfully in CI/local"
    - "Foundry Agent Framework SDK dependencies are present with a non-destructive smoke script"
  artifacts:
    - path: "scripts/dev.sh"
      provides: "Dev server launcher"
    - path: "pytest.ini"
      provides: "Test runner config and pythonpath"
    - path: "scripts/foundry_smoke.py"
      provides: "Read-only Foundry connection smoke test"
  key_links:
    - from: "scripts/dev.sh"
      to: "src/web/app.py"
      via: "uvicorn module path"
      pattern: "uvicorn\\s+web\\.app:app"
    - from: "scripts/foundry_smoke.py"
      to: "src/azure/foundry.py"
      via: "get_project_client"
      pattern: "get_project_client"
---

<objective>
Add the Phase 1 developer ergonomics (dev script + test harness) and the optional Foundry connectivity smoke test.

Purpose: Keep later implementation fast and ensure Foundry access can be verified without side effects.
Output: `scripts/dev.sh`, `pytest.ini`, smoke tests, and Foundry SDK config + smoke script.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dev script + pytest harness + smoke test</name>
  <files>scripts/dev.sh, pytest.ini, tests/test_smoke.py</files>
  <action>
Create `scripts/dev.sh`:
- Creates `.venv` if missing, installs deps (`requirements.txt` + `requirements-dev.txt`), and starts `uvicorn web.app:app --reload`.
- Keep it bash-safe and idempotent.

Create `pytest.ini`:
- Configure `pythonpath = src` so tests can import `agents`, `models`, `storage`, `web` without needing `PYTHONPATH=`.

Create `tests/test_smoke.py`:
- Imports `web.app:app` and asserts the FastAPI app loads.
- Optionally uses FastAPI TestClient to assert `GET /health` returns 200.
  </action>
  <verify>. .venv/bin/activate && pip install -r requirements.txt -r requirements-dev.txt && pytest -q</verify>
  <done>`pytest -q` passes and `scripts/dev.sh` uses `uvicorn web.app:app`.</done>
</task>

<task type="auto">
  <name>Task 2: Add Foundry config + non-destructive smoke script</name>
  <files>requirements.txt, .env.example, infra/foundry_config.yaml, src/azure/foundry.py, scripts/foundry_smoke.py</files>
  <action>
Add Azure AI Foundry (Agent Framework SDK) dependencies to `requirements.txt`:
- `azure-ai-projects`

Update `.env.example` with:
- `AZURE_AI_PROJECT_ENDPOINT=` (example format: `https://{ai-services-account}.services.ai.azure.com/api/projects/{project-name}`)

Create/update `infra/foundry_config.yaml` to include non-secret placeholders referencing env vars:
- `azure_ai_project_endpoint: ${AZURE_AI_PROJECT_ENDPOINT}`
- a short comment describing where to get the endpoint in Foundry

Create `src/azure/foundry.py`:
- `get_ai_project_endpoint()` reads `AZURE_AI_PROJECT_ENDPOINT` and raises a clear error if missing
- `get_project_client(endpoint: str | None = None)` returns an `AIProjectClient` configured with `DefaultAzureCredential`

Create `scripts/foundry_smoke.py`:
- Authenticates with `DefaultAzureCredential`
- Connects an `AIProjectClient` using the endpoint
- Calls a read-only method (e.g., list agents with limit=1) and prints a short OK message
- Must not create/modify agents
  </action>
  <verify>. .venv/bin/activate && pip install -r requirements.txt -r requirements-dev.txt && python3 -c "from azure.ai.projects import AIProjectClient; from azure.identity import DefaultAzureCredential; print('ok')"</verify>
  <done>Repo includes Foundry SDK deps + a read-only smoke script; no secrets are committed.</done>
</task>

</tasks>

<verification>
- `pytest -q` passes
- `scripts/dev.sh` starts a local server that responds on `/health`
</verification>

<success_criteria>
- Repo has a runnable FastAPI webhook receiver, a green test run, and a Foundry smoke script available
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
