---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - requirements.txt
  - src/azure/auth.py
  - src/azure/cost_management.py
  - src/models/anomaly.py
  - src/models/time_range.py
  - scripts/cost_management_smoke.py
  - tests/test_anomaly_model.py
  - tests/test_cost_query_build.py
autonomous: true
user_setup:
  - service: azure
    why: "Authenticate and query Cost Management"
    env_vars:
      - name: AZURE_SUBSCRIPTION_ID
        source: "Azure Portal -> Subscriptions"
      - name: AZURE_TENANT_ID
        source: "Microsoft Entra ID -> Overview"
      - name: AZURE_CLIENT_ID
        source: "Entra ID -> App registrations -> (app)"
      - name: AZURE_CLIENT_SECRET
        source: "Entra ID -> App registrations -> Certificates & secrets"
    dashboard_config:
      - task: "Grant the app Reader (or Cost Management Reader) on the subscription"
        location: "Azure Portal -> Subscriptions -> Access control (IAM)"

must_haves:
  truths:
    - "Cost Analyst can request a last-7-days cost query payload"
    - "Anomaly model validates required fields and serializes to JSON"
  artifacts:
    - path: "src/azure/cost_management.py"
      provides: "Cost query client wrapper"
    - path: "src/models/anomaly.py"
      provides: "Pydantic anomaly model"
  key_links:
    - from: "src/azure/cost_management.py"
      to: "azure.mgmt.costmanagement"
      via: "CostManagementClient.query.usage"
      pattern: "query\\.usage"
---

<objective>
Implement Azure authentication + a Cost Management query client, plus the core anomaly data model.

Purpose: Make Phase 1 success criteria real: retrieve cost data for last 7 days and represent anomalies as structured objects.
Output: Azure auth helper, cost client wrapper, anomaly model + tests.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Azure auth helper (DefaultAzureCredential + subscription id)</name>
  <files>src/azure/auth.py, requirements.txt</files>
  <action>
Add Azure SDK dependencies to `requirements.txt`:
- `azure-identity`
- `azure-mgmt-costmanagement`

Create `src/azure/auth.py` with:
- `get_credential()` returning `DefaultAzureCredential` (support Azure CLI auth and service principal env vars)
- `get_subscription_id()` that reads `AZURE_SUBSCRIPTION_ID` and raises a clear error if missing
Keep it side-effect free (no login prompts).
  </action>
  <verify>. .venv/bin/activate && pip install -r requirements.txt -r requirements-dev.txt && PYTHONPATH=src python3 -c "from azure.auth import get_credential, get_subscription_id; print(type(get_credential()).__name__)"</verify>
  <done>Azure SDK imports succeed; subscription id helper is present with a clear error message when env var missing.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Cost Management query wrapper for last-7-days costs</name>
  <files>src/azure/cost_management.py, scripts/cost_management_smoke.py, tests/test_cost_query_build.py</files>
  <action>
Create `src/azure/cost_management.py` using `azure.mgmt.costmanagement.CostManagementClient`:
- Provide `build_last_7_days_query_definition()` returning a `QueryDefinition` configured for daily granularity and a SUM aggregation on cost.
- Provide `query_last_7_days_costs_by_resource(credential, subscription_id)` that calls `client.query.usage(scope, definition)` where `scope` is `/subscriptions/{subscription_id}`.
- Keep response parsing minimal: return the raw result and also a helper that converts rows -> list of `{resource_id, total_cost, currency, date}` if the result format allows.

Create `scripts/cost_management_smoke.py`:
- Reads `AZURE_SUBSCRIPTION_ID` and authenticates via `DefaultAzureCredential` (same behavior as `get_credential()`)
- Calls `query_last_7_days_costs_by_resource(...)`
- Prints a short summary (e.g., number of rows / keys present) and exits 0 on success
- Lets exceptions raise (non-zero) so failures prove access is not configured

Add `tests/test_cost_query_build.py` that asserts the query definition is built with expected granularity, aggregation keys, and timeframe = Custom (7-day window) or a documented equivalent.
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src pytest -q</verify>
  <done>Unit test passes and query wrapper function exists with scope `/subscriptions/{id}` and `query.usage(...)` call.</done>
</task>

<task type="auto">
  <name>Task 3: Implement anomaly model with validation</name>
  <files>src/models/anomaly.py, src/models/time_range.py, tests/test_anomaly_model.py</files>
  <action>
Create Pydantic models:
- `src/models/time_range.py`: a `TimeRange` with `start` and `end` (UTC ISO8601), validation `start < end`.
- `src/models/anomaly.py`: an `Anomaly` model that can represent a cost spike with fields:
  - `anomaly_type` (literal/enum like `spike`)
  - `scope` (subscription id or billing scope)
  - `resource_id` (optional if unknown)
  - `cost_before`, `cost_after` (numbers)
  - `currency` (string)
  - `time_range` (TimeRange)
  - `summary` (short text)

Add `tests/test_anomaly_model.py` covering: valid instance, invalid time range, negative cost rejected.
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src pytest -q</verify>
  <done>Anomaly model exists, validates, and tests cover basic failure modes.</done>
</task>

</tasks>

<verification>
- Unit tests validate query-definition construction and anomaly validation
- Manual smoke (proves FOUND-01 Cost Management access):
  - Ensure Azure creds are available (either `az login` works OR service principal env vars `AZURE_TENANT_ID`, `AZURE_CLIENT_ID`, `AZURE_CLIENT_SECRET` are set) and `AZURE_SUBSCRIPTION_ID` is set
  - Run: `. .venv/bin/activate && PYTHONPATH=src python3 scripts/cost_management_smoke.py`
  - Expected: exits 0 without 401/403; prints a summary of the response
</verification>

<success_criteria>
- Codebase has a working Cost Management SDK wrapper and a structured anomaly model
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
