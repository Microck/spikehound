---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/agents/coordinator.py
  - src/agents/cost_analyst.py
  - src/models/findings.py
  - src/web/app.py
  - tests/test_webhook_flow.py
autonomous: true

must_haves:
  truths:
    - "Coordinator accepts an alert webhook and kicks off an investigation"
    - "Cost Analyst agent can be invoked and returns structured findings"
  artifacts:
    - path: "src/agents/coordinator.py"
      provides: "Investigation orchestration entrypoint"
    - path: "src/agents/cost_analyst.py"
      provides: "Cost analyst agent implementation"
    - path: "src/models/findings.py"
      provides: "Structured findings output for later aggregation"
  key_links:
    - from: "src/web/app.py"
      to: "src/agents/coordinator.py"
      via: "POST /webhooks/alert handler"
      pattern: "Coordinator"
---

<objective>
Wire the Phase 1 vertical slice: webhook -> coordinator -> cost analyst -> structured findings response.

Purpose: Demonstrate the core loop end-to-end with only the Cost Analyst agent.
Output: Coordinator + Cost Analyst agents and a webhook route that triggers them.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Findings model for agent outputs</name>
  <files>src/models/findings.py</files>
  <action>
Create `src/models/findings.py` with Pydantic models representing the minimal findings for Phase 1:
- `CostFinding`: top cost drivers (resource_id, cost, currency)
- `InvestigationFindings`: fields `alert_id`, `received_at`, `cost_findings: list[CostFinding]`, and `notes`.
Keep this intentionally minimal; later phases will extend/compose.
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src python3 -c "from models.findings import InvestigationFindings; print(InvestigationFindings.model_json_schema()['title'])"</verify>
  <done>Findings models exist and produce JSON schema without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Cost Analyst agent (uses cost_management wrapper)</name>
  <files>src/agents/cost_analyst.py</files>
  <action>
Create `src/agents/cost_analyst.py`:
- Implement a `CostAnalystAgent` class with a method like `run(alert_payload) -> InvestigationFindings`.
- Read `AZURE_SUBSCRIPTION_ID` using existing helper.
- Use `azure.cost_management.query_last_7_days_costs_by_resource(...)` to fetch data.
- Convert results into a few `CostFinding` items (top N). If Azure creds are not configured, return findings with `notes` explaining missing credentials (do not crash the entire webhook).
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src python3 -c "from agents.cost_analyst import CostAnalystAgent; a=CostAnalystAgent(); print(a)"</verify>
  <done>Cost Analyst agent module exists, imports cleanly, and has a deterministic output shape (InvestigationFindings).</done>
</task>

<task type="auto">
  <name>Task 3: Implement Coordinator + webhook endpoint wiring</name>
  <files>src/agents/coordinator.py, src/web/app.py, tests/test_webhook_flow.py</files>
  <action>
Implement `src/agents/coordinator.py`:
- `CoordinatorAgent.handle_alert(alert_payload) -> InvestigationFindings` that calls `CostAnalystAgent.run(...)`.
- Add basic state fields (alert_id, timestamps) but keep state management in-memory for Phase 1.

Update `src/web/app.py`:
- In `POST /webhooks/alert`, call `CoordinatorAgent.handle_alert` and return the findings JSON.

Add `tests/test_webhook_flow.py` using FastAPI TestClient:
- POST an example JSON payload
- Assert 200 and response includes expected keys from `InvestigationFindings`.
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src pytest -q</verify>
  <done>Webhook endpoint returns structured findings and a unit test covers the end-to-end local flow.</done>
</task>

</tasks>

<verification>
- `pytest` passes
- Manual smoke: run server and `curl -X POST localhost:8000/webhooks/alert -d '{}'` returns JSON findings
</verification>

<success_criteria>
- Phase 1 end-to-end path exists: webhook -> coordinator -> cost analyst -> findings
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
