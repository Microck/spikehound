---
phase: 03-diagnosis-remediation
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - src/agents/coordinator.py
  - src/models/findings.py
  - src/web/app.py
  - tests/test_e2e_pipeline_local.py
autonomous: true

must_haves:
  truths:
    - "A single webhook call returns unified findings + diagnosis + remediation suggestions"
    - "Pipeline output is stable JSON suitable for Slack messaging"
  artifacts:
    - path: "src/agents/coordinator.py"
      provides: "Orchestrates investigators -> diagnosis -> remediation"
    - path: "src/web/app.py"
      provides: "Webhook endpoint returns full pipeline output"
  key_links:
    - from: "src/agents/coordinator.py"
      to: "src/agents/diagnosis_agent.py"
      via: "call after investigators"
      pattern: "DiagnosisAgent"
---

<objective>
Wire Diagnosis and Remediation into the main coordinator flow and return everything from the webhook.

Purpose: Achieve Phase 3 end-to-end investigation with suggestions.
Output: Coordinator updates + web response schema + local e2e test.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-diagnosis-remediation/03-01-SUMMARY.md
@.planning/phases/03-diagnosis-remediation/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend coordinator pipeline to include diagnosis and remediation</name>
  <files>src/agents/coordinator.py, src/models/findings.py</files>
  <action>
Update `src/agents/coordinator.py` to:
- Run the three investigator agents (existing)
- Then run `DiagnosisAgent` on `UnifiedFindings`
- Then run `RemediationAgent` on `UnifiedFindings + Diagnosis`

Update the top-level response model in `src/models/findings.py` (or add a new `InvestigationReport`) that includes:
- `unified_findings`
- `diagnosis_result`
- `remediation_result`
All of these should be AgentResults.
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src python3 -c "from agents.coordinator import CoordinatorAgent; print('ok')"</verify>
  <done>Coordinator produces a full report object that includes diagnosis + remediation results.</done>
</task>

<task type="auto">
  <name>Task 2: Update webhook response to return the full report</name>
  <files>src/web/app.py</files>
  <action>
Update `POST /webhooks/alert`:
- Return the full report JSON (unified findings + diagnosis + remediation).
- Ensure errors/degraded statuses are still returned as structured AgentResults (no 500s for missing config).
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src pytest -q</verify>
  <done>Webhook returns a stable JSON structure including all agent results.</done>
</task>

<task type="auto">
  <name>Task 3: Add a local e2e test with monkeypatched agents</name>
  <files>tests/test_e2e_pipeline_local.py</files>
  <action>
Create `tests/test_e2e_pipeline_local.py`:
- Monkeypatch investigator/diagnosis/remediation agents to return deterministic AgentResults.
- POST to `/webhooks/alert` and assert the response includes all expected sections.
This test ensures wiring works without requiring any Azure or Foundry credentials.
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src pytest -q</verify>
  <done>End-to-end wiring is covered by a deterministic local test.</done>
</task>

</tasks>

<verification>
- `pytest` passes
- Manual smoke: run server and call webhook; response contains 5 agent result sections (cost/resource/history/diagnosis/remediation)
</verification>

<success_criteria>
- Phase 3 success criteria met: end-to-end investigation with diagnosis and remediation suggestions
</success_criteria>

<output>
After completion, create `.planning/phases/03-diagnosis-remediation/03-03-SUMMARY.md`
</output>
