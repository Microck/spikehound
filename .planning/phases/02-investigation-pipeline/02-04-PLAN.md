---
phase: 02-investigation-pipeline
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/agents/coordinator.py
  - src/agents/cost_analyst.py
  - src/agents/resource_agent.py
  - src/agents/history_agent.py
  - src/models/findings.py
  - src/web/app.py
  - tests/test_parallel_investigation.py
autonomous: true

must_haves:
  truths:
    - "Coordinator spawns Cost, Resource, and History agents in parallel"
    - "Coordinator aggregates all results into UnifiedFindings"
  artifacts:
    - path: "src/agents/coordinator.py"
      provides: "Parallel orchestration + aggregation"
    - path: "src/models/findings.py"
      provides: "UnifiedFindings merge and schema"
  key_links:
    - from: "src/agents/coordinator.py"
      to: "src/agents/resource_agent.py"
      via: "async task/ThreadPool"
      pattern: "ResourceAgent"
---

<objective>
Upgrade the coordinator to run three investigator agents concurrently and aggregate their results.

Purpose: Meet Phase 2 requirement INV-05/INV-06 and create a unified findings object.
Output: Parallel orchestration in coordinator + updated webhook route returning unified findings.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-investigation-pipeline/02-02-SUMMARY.md
@.planning/phases/02-investigation-pipeline/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert agents to a consistent run() signature and AgentResult envelope</name>
  <files>src/agents/cost_analyst.py, src/agents/resource_agent.py, src/agents/history_agent.py</files>
  <action>
Ensure each investigator agent implements:
- `run(alert_payload, hints=None) -> AgentResult`

Align error handling:
- exceptions become `status=error` with `errors=[...]`
- missing env/config becomes `status=degraded` with `notes`
Keep outputs in their dedicated findings models.
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src python3 -c "from agents.cost_analyst import CostAnalystAgent; from agents.resource_agent import ResourceAgent; from agents.history_agent import HistoryAgent; print('ok')"</verify>
  <done>All three agents return an AgentResult with `agent` set correctly and never raise unhandled exceptions.</done>
</task>

<task type="auto">
  <name>Task 2: Implement coordinator parallel execution with timeouts</name>
  <files>src/agents/coordinator.py, src/models/findings.py</files>
  <action>
Update `src/agents/coordinator.py`:
- Implement `handle_alert(alert_payload) -> UnifiedFindings` that:
  - starts Cost, Resource, History runs concurrently (use `asyncio.gather` with `asyncio.to_thread` if agents are sync)
  - enforces per-agent timeout (e.g., 20s) and marks timed-out agents as `status=error` with timeout error
  - merges results via `UnifiedFindings.merge([...])`

Update `src/models/findings.py` if needed to support `results` mapping.
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src pytest -q</verify>
  <done>Coordinator produces UnifiedFindings containing 3 agent results (ok/degraded/error) and merge is deterministic.</done>
</task>

<task type="auto">
  <name>Task 3: Update webhook to return UnifiedFindings and add parallel test</name>
  <files>src/web/app.py, tests/test_parallel_investigation.py</files>
  <action>
Update `src/web/app.py`:
- `POST /webhooks/alert` returns the `UnifiedFindings` JSON schema.

Add `tests/test_parallel_investigation.py`:
- Monkeypatch agent `run` methods to use deterministic instrumentation (no wall-clock performance assertions):
  - Create `started` events for each agent (`threading.Event`) and a shared `threading.Barrier(4)`.
  - Each patched `run` sets its `started` event and then calls `barrier.wait(timeout=5)` before returning a deterministic AgentResult.
  - The test invokes the coordinator, waits for all three `started` events, then calls `barrier.wait(timeout=5)` to release all agents.
  - If coordinator is sequential, at most one agent will reach the barrier; the test's `barrier.wait` will time out and fail.
- Assert coordinator returns merged results with 3 AgentResults (and no barrier timeouts).
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src pytest -q</verify>
  <done>Webhook returns unified findings and the unit test deterministically proves parallel start (barrier + started events), without flaky timing thresholds.</done>
</task>

</tasks>

<verification>
- `pytest` passes
- Manual smoke: POST alert payload and see 3 agent results in response
</verification>

<success_criteria>
- Phase 2 success criteria met: three agents execute and results aggregate
</success_criteria>

<output>
After completion, create `.planning/phases/02-investigation-pipeline/02-04-SUMMARY.md`
</output>
