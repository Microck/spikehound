---
phase: 02-investigation-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - requirements.txt
  - src/azure/resource_graph.py
  - src/azure/activity_logs.py
  - src/agents/resource_agent.py
  - src/models/resource_findings.py
  - tests/test_resource_agent_smoke.py
autonomous: true
user_setup:
  - service: azure
    why: "Query Resource Graph + Activity Logs"
    env_vars:
      - name: AZURE_SUBSCRIPTION_ID
        source: "Azure Portal -> Subscriptions"
    dashboard_config:
      - task: "Ensure principal has Reader + Monitoring Reader roles"
        location: "Azure Portal -> Subscriptions -> Access control (IAM)"

must_haves:
  truths:
    - "Resource Agent can query Resource Graph for a resource id"
    - "Resource Agent can retrieve Activity Logs for recent changes"
  artifacts:
    - path: "src/agents/resource_agent.py"
      provides: "Resource Agent implementation"
    - path: "src/azure/resource_graph.py"
      provides: "Resource Graph client wrapper"
    - path: "src/azure/activity_logs.py"
      provides: "Activity logs client wrapper"
  key_links:
    - from: "src/agents/resource_agent.py"
      to: "src/azure/resource_graph.py"
      via: "KQL query"
      pattern: "ResourceGraphClient"
---

<objective>
Implement the Resource Agent: fetch resource configuration and identify recent changes.

Purpose: Complement cost data with "what resource changed" evidence.
Output: Azure Resource Graph wrapper, Activity Logs wrapper, Resource Agent + findings model.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-investigation-pipeline/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Azure SDK wrappers for Resource Graph and Activity Logs</name>
  <files>requirements.txt, src/azure/resource_graph.py, src/azure/activity_logs.py</files>
  <action>
Add dependencies to `requirements.txt`:
- `azure-mgmt-resourcegraph`
- `azure-mgmt-resource`
- `azure-mgmt-monitor`

Create `src/azure/resource_graph.py`:
- `query_resources(credential, subscription_ids, kql) -> list[dict]` using `ResourceGraphClient.resources(QueryRequest(...))` with `result_format="objectArray"`.

Create `src/azure/activity_logs.py`:
- `list_activity_logs(credential, subscription_id, start_utc, end_utc, resource_id=None, resource_group=None) -> list[dict]` using `MonitorManagementClient.activity_logs.list(filter=...)`.
- Convert SDK objects to simple dicts (only include stable fields: timestamp, caller, operation, status, resource_id).
  </action>
  <verify>. .venv/bin/activate && pip install -r requirements.txt -r requirements-dev.txt && PYTHONPATH=src python3 -c "from azure.resource_graph import query_resources; from azure.activity_logs import list_activity_logs; print('ok')"</verify>
  <done>Wrappers exist and import cleanly with Azure SDK dependencies installed.</done>
</task>

<task type="auto">
  <name>Task 2: Create Resource findings model</name>
  <files>src/models/resource_findings.py</files>
  <action>
Create `src/models/resource_findings.py` with Pydantic models:
- `ResourceConfig`: `resource_id`, `name`, `type`, `location`, `tags`, `properties` (dict)
- `ResourceChange`: `timestamp`, `caller`, `operation`, `status`, `correlation_id` (optional)
- `ResourceFindings`: `target_resource_id`, `config`, `recent_changes: list[ResourceChange]`, `notes`
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src python3 -c "from models.resource_findings import ResourceFindings; print('ok')"</verify>
  <done>Resource findings models exist and serialize to JSON.</done>
</task>

<task type="auto">
  <name>Task 3: Implement Resource Agent (returns AgentResult[ResourceFindings])</name>
  <files>src/agents/resource_agent.py, tests/test_resource_agent_smoke.py</files>
  <action>
Create `src/agents/resource_agent.py`:
- `ResourceAgent.run(alert_payload) -> AgentResult`.
- Derive target resource candidates from alert payload if present; if not, accept `resource_id` as optional input and set `status=degraded` when unknown.
- Use Resource Graph KQL to fetch config for the resource id (or top resources by cost driver if passed from coordinator later).
- Fetch Activity Logs for last 7 days filtered by `resourceUri eq '{resource_id}'`.

Add `tests/test_resource_agent_smoke.py`:
- Construct a minimal alert payload with a fake `resource_id` and assert the agent returns an AgentResult with `agent==resource` and a `ResourceFindings`-shaped `data`.
Do not require Azure creds for this test; if creds missing, agent should return `status=degraded` with a note.
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src pytest -q</verify>
  <done>Resource Agent exists, returns a consistent AgentResult envelope, and does not crash when Azure is not configured.</done>
</task>

</tasks>

<verification>
- `pytest` passes
- (If Azure creds exist) manual smoke: run Resource Agent against a known resource id
</verification>

<success_criteria>
- Resource Agent can retrieve config and recent change metadata (or degrade gracefully)
</success_criteria>

<output>
After completion, create `.planning/phases/02-investigation-pipeline/02-02-SUMMARY.md`
</output>
