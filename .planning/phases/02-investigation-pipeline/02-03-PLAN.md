---
phase: 02-investigation-pipeline
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - requirements.txt
  - src/storage/cosmos_incident_store.py
  - src/storage/ai_search_incident_search.py
  - src/agents/history_agent.py
  - src/models/history_findings.py
  - tests/test_history_agent_smoke.py
autonomous: true
user_setup:
  - service: azure-ai-search
    why: "Vector search over incident history"
    env_vars:
      - name: AZURE_SEARCH_ENDPOINT
        source: "Azure Portal -> AI Search -> Overview"
      - name: AZURE_SEARCH_API_KEY
        source: "Azure Portal -> AI Search -> Keys"
      - name: AZURE_SEARCH_INDEX
        source: "Name of the incidents index"
  - service: cosmosdb
    why: "Persist incident records"
    env_vars:
      - name: COSMOS_ENDPOINT
        source: "Azure Portal -> Cosmos DB -> Overview"
      - name: COSMOS_KEY
        source: "Azure Portal -> Cosmos DB -> Keys"
      - name: COSMOS_DATABASE
        source: "Cosmos DB database name"
      - name: COSMOS_CONTAINER
        source: "Cosmos DB container name"

must_haves:
  truths:
    - "History Agent can retrieve similar incidents via IncidentSearch (or fallback)"
    - "Incident records can be stored and read back via IncidentStore (or fallback)"
  artifacts:
    - path: "src/storage/cosmos_incident_store.py"
      provides: "Cosmos-backed IncidentStore implementation"
    - path: "src/storage/ai_search_incident_search.py"
      provides: "Azure AI Search-backed IncidentSearch implementation"
    - path: "src/agents/history_agent.py"
      provides: "History Agent implementation"
  key_links:
    - from: "src/agents/history_agent.py"
      to: "src/storage/incident_store.py"
      via: "put/get/list_recent"
      pattern: "\\.put\\(|\\.get\\(|list_recent"
    - from: "src/agents/history_agent.py"
      to: "src/storage/incident_search.py"
      via: "search_similar"
      pattern: "search_similar"
    - from: "src/storage/incident_search.py"
      to: "src/storage/incident_store.py"
      via: "local fallback candidate scan"
      pattern: "list_recent"
    - from: "src/storage/ai_search_incident_search.py"
      to: "azure.search.documents"
      via: "SearchClient.search"
      pattern: "SearchClient\\.search"
---

<objective>
Implement the History Agent with a real storage/search backend (Cosmos DB + Azure AI Search), with a safe fallback if not configured.

Purpose: Enable "have we seen this before?" and pull prior resolutions.
Output: Cosmos incident store, Azure AI Search incident search, History Agent + findings model.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-investigation-pipeline/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Cosmos DB IncidentStore implementation</name>
  <files>requirements.txt, src/storage/cosmos_incident_store.py</files>
  <action>
Add dependency to `requirements.txt`: `azure-cosmos`.

Create `src/storage/cosmos_incident_store.py` implementing the `IncidentStore` interface from `src/storage/incident_store.py`:
- Connect using `COSMOS_ENDPOINT` + `COSMOS_KEY`.
- Ensure database/container exist (create if missing) only if safe in dev; otherwise fail with a clear message.
- Implement `put(record)`, `get(id)`, and `list_recent(limit=50)`.
If env vars are missing, raise a clear error that can be caught by the History Agent to degrade gracefully.
  </action>
  <verify>. .venv/bin/activate && pip install -r requirements.txt -r requirements-dev.txt && PYTHONPATH=src python3 -c "from storage.cosmos_incident_store import CosmosIncidentStore; print('ok')"</verify>
  <done>Cosmos incident store class exists and can be instantiated when env vars are present.</done>
</task>

<task type="auto">
  <name>Task 2: Add Azure AI Search IncidentSearch implementation</name>
  <files>requirements.txt, src/storage/ai_search_incident_search.py</files>
  <action>
Add dependency to `requirements.txt`: `azure-search-documents`.

Create `src/storage/ai_search_incident_search.py` implementing `IncidentSearch` from `src/storage/incident_search.py`:
- `AzureAISearchIncidentSearch.search_similar(query: str, k: int)` uses `SearchClient.search(search_text=query, top=k)`.
- Keep it simple (BM25 keyword search is acceptable for MVP). If vector fields are available, add an optional vector path behind feature detection.
- Require `AZURE_SEARCH_ENDPOINT`, `AZURE_SEARCH_API_KEY`, `AZURE_SEARCH_INDEX`.
- Validate env vars at call time (not import time).
- Return shape: list of dicts including at minimum `id` and optional `score`.
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src python3 -c "from storage.ai_search_incident_search import AzureAISearchIncidentSearch; print('ok')"</verify>
  <done>IncidentSearch implementation exists and validates required env vars at call time (not import time).</done>
</task>

<task type="auto">
  <name>Task 3: Implement History Agent (returns AgentResult[HistoryFindings])</name>
  <files>src/models/history_findings.py, src/agents/history_agent.py, tests/test_history_agent_smoke.py</files>
  <action>
Create `src/models/history_findings.py`:
- `SimilarIncident`: `id`, `title`, `summary`, `resolution`, `score` (optional)
- `HistoryFindings`: `query`, `matches: list[SimilarIncident]`, `notes`

Create `src/agents/history_agent.py`:
- `HistoryAgent.run(alert_payload, unified_findings_hint=None) -> AgentResult`.
- Instantiate/accept dependencies:
  - `store: IncidentStore` (defaults to `MemoryIncidentStore`)
  - `search: IncidentSearch` (defaults to `LocalIncidentSearch(store)`)
- Build a query string from cost/resource hints (resource type, resource name, cost spike details).
- Best-effort persist a minimal `IncidentRecord` for the current alert via `store.put(...)` (if store errors due to missing env/config, degrade gracefully).
- Query similar incidents via `search.search_similar(query, k)`.
- Convert search hits into `SimilarIncident` items by fetching details via `store.get(id)` when possible (so HistoryFindings stays consistent across backends).
- If AI Search/Cosmos is not configured, return `status=degraded` with empty matches (but do not crash).

Add `tests/test_history_agent_smoke.py` asserting:
- Returns `AgentResult` with `agent==history`
- Degrades gracefully when env vars absent
  </action>
  <verify>. .venv/bin/activate && PYTHONPATH=src pytest -q</verify>
  <done>History Agent exists and returns a stable result envelope even without Azure AI Search configured.</done>
</task>

</tasks>

<verification>
- `pytest` passes
- (If Azure resources configured) seed 1 incident record in Cosmos, query it via AI Search, and confirm a match is returned
</verification>

<success_criteria>
- History Agent can provide prior incident context (or degrade gracefully)
</success_criteria>

<output>
After completion, create `.planning/phases/02-investigation-pipeline/02-03-SUMMARY.md`
</output>
