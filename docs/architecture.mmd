flowchart TB
    AM([Azure Monitor\nCost Alert])

    AW["POST /api/webhooks/alert\nAlertWebhookFunction"]

    AM --> AW

    AW -->|"SPIKEHOUND_USE_DURABLE=false&#10;200 OK + full report"| INLINE
    AW -->|"SPIKEHOUND_USE_DURABLE=true&#10;202 Accepted + instanceId"| DURABLE

    subgraph INLINE ["Inline — CoordinatorPipeline"]
        direction TB

        subgraph PAR ["Parallel Investigation  Task.WhenAll"]
            direction LR
            CA["Cost Analyst\nCost Management API"]
            RA["Resource Agent\nResource Graph"]
            HA["History Agent\nAI Search / Cosmos DB"]
        end

        CF["Unified Findings"]
        DA["Diagnosis Agent\nAzure AI Foundry / GPT-4o"]
        RP["Remediation Agent\nAction Planner"]

        CA --> CF
        RA --> CF
        HA --> CF
        CF --> DA
        DA --> RP
    end

    subgraph DURABLE ["Durable — CoordinatorOrchestrator"]
        direction TB
        DCA["CostAgentActivity"]
        DRA["ResourceAgentActivity"]
        DHA["HistoryAgentActivity"]
        DFI["DiagnosisActivity"]
        DRE["RemediationActivity"]
        DNA["NotificationActivity"]

        DCA --> DFI
        DRA --> DFI
        DHA --> DFI
        DFI --> DRE
        DRE --> DNA
    end

    SN["Slack\nIncoming Webhook"]
    DN["Discord\nBot Message"]

    RP --> SN
    RP --> DN
    DNA --> SN
    DNA --> DN

    AREC["ApprovalRecord\nInMemoryState"]

    SN -->|"approve / reject / investigate"| AREC
    DN -->|"approve / reject / investigate"| AREC

    GATE{"Remediation Gate\nSPIKEHOUND_ENABLE_\nREMEDIATION_EXECUTION"}

    AREC -->|"decision = Approve"| GATE

    REO["RemediationExecutionOrchestrator\nDurable Function"]
    SAFE["Execution Skipped\nsafety default"]

    GATE -->|"enabled = true"| REO
    GATE -->|"enabled = false (default)"| SAFE

    AZ["Azure Compute\nstop_vm"]
    FU["Follow-up Notification\nSlack + Discord"]

    REO --> AZ
    AZ --> FU

    classDef azure   fill:#e6f3ff,stroke:#0066cc,color:#003d7a
    classDef agent   fill:#f0f7ee,stroke:#3a7d44,color:#1b4332
    classDef human   fill:#fff8e1,stroke:#f9a825,color:#5d4037
    classDef safe    fill:#e8f5e9,stroke:#2e7d32,color:#1b5e20
    classDef neutral fill:#fafafa,stroke:#9e9e9e,color:#212121

    class AM,AZ azure
    class CA,RA,HA,DA,RP,DCA,DRA,DHA,DFI,DRE agent
    class SN,DN,AREC human
    class SAFE,FU safe
    class CF,REO,GATE,AW,DNA neutral
